import { useEffect, useState } from 'react';
import { ComposableMap, Geographies, Geography, Marker } from 'react-simple-maps';
import { getRegionCarbonStats } from '../../../../api/main/regionStatsApi';
import {
    InfoBox,
    InfoContent,
    InfoDescription,
    InfoIcon,
    InfoTitle,
    LoadingText,
    MapContainer,
    MapWrapper,
    Tooltip
} from './RegionStatsMap.styled';

const RegionStatsMap = () => {
    const [regionData, setRegionData] = useState([]);
    const [loading, setLoading] = useState(true);
    const [hoveredRegion, setHoveredRegion] = useState(null);
    const [tooltipContent, setTooltipContent] = useState('');

    useEffect(() => {
        const fetchData = async () => {
            try {
                const data = await getRegionParticipationStats();
                // 최근 3개월 평균 참여율로 변환
                const mapped = data.map(item => {
                    const avgPtcpRt = Math.round(
                        item.history.reduce((sum, h) => sum + h.ptcpRt, 0) / item.history.length
                    );
                    // 좌표 등은 기존 regionStatsApi.js의 좌표 매핑 참고
                    const regionInfo = getDummyRegionStats().find(r => r.region === item.region);
                    return {
                        region: item.region,
                        value: avgPtcpRt,
                        lat: regionInfo?.lat,
                        lng: regionInfo?.lng
                    };
                });
                setRegionData(mapped);
            } catch (err) {
                console.error('Failed to fetch region data:', err);
            } finally {
                setLoading(false);
            }
        };
        fetchData();
    }, []);

    if (loading) {
        return (
            <MapContainer>
                <LoadingText>데이터 로딩 중...</LoadingText>
            </MapContainer>
        );
    }

    // 버블 크기 계산 (value에 따라)
    const getBubbleSize = (value) => {
        const minSize = 20;
        const maxSize = 60;
        const maxValue = Math.max(...regionData.map(r => r.value));
        return minSize + ((value / maxValue) * (maxSize - minSize));
    };

    return (
        <MapContainer>
            <InfoBox>
                <InfoIcon className="bi bi-geo-alt-fill" />
                <InfoContent>
                    <InfoTitle>
                        광역시 지역별 탄소중립 포인트
                    </InfoTitle>
                    <InfoDescription>
                        각 지역의 친환경 실천 활동을 통해 적립된 포인트를 확인하세요
                    </InfoDescription>
                </InfoContent>
            </InfoBox>
            
            <MapWrapper>
                <ComposableMap
                    projection="geoMercator"
                    projectionConfig={{
                        scale: 6000,
                        center: [127.7, 36.3]
                    }}
                    width={500}
                    height={800}
                    style={{ width: '100%', height: 'auto'}}
                >
                    <Geographies geography="/maps/south-korea-provinces.json">
                        {({ geographies }) =>
                            geographies.map((geo) => (
                                <Geography
                                    key={geo.rsmKey}
                                    geography={geo}
                                    fill="#e8f0f3ff"
                                    stroke="#a1d4e6ff"
                                    strokeWidth={1.5}
                                    style={{
                                        default: { outline: 'none' },
                                        hover: { 
                                            fill: '#aad3e2ff',
                                            outline: 'none'
                                        },
                                        pressed: { outline: 'none' }
                                    }}
                                />
                            ))
                        }
                    </Geographies>

                    {/* 버블 마커 */}
                    {regionData.map((region) => {
                        const size = getBubbleSize(region.value);
                        const isHovered = hoveredRegion === region.region;
                        
                        return (
                            <Marker
                                key={region.region}
                                coordinates={[region.lng, region.lat]}
                            >
                                <g
                                    onMouseEnter={() => {
                                        setHoveredRegion(region.region);
                                        setTooltipContent(`${region.region}: ${region.value.toLocaleString()} 포인트`);
                                    }}
                                    onMouseLeave={() => {
                                        setHoveredRegion(null);
                                        setTooltipContent('');
                                    }}
                                    style={{ cursor: 'pointer' }}
                                >
                                    <circle
                                        r={isHovered ? size + 3 : size}
                                        fill="#34ade5b8"
                                        fillOpacity={isHovered ? 0.95 : 0.85}
                                        stroke="#34ade5b8"
                                        strokeWidth={2}
                                        style={{
                                            transition: 'all 0.3s ease',
                                            filter: 'drop-shadow(2px 2px 4px rgba(0,0,0,0.3))'
                                        }}
                                    />
                                    <text
                                        textAnchor="middle"
                                        y={-size - 10}
                                        style={{
                                            fill: '#333333',
                                            fontSize: isHovered ? '22px' : '20px',
                                            fontWeight: 'bold',
                                            pointerEvents: 'none'
                                        }}
                                    >
                                        {region.region}
                                    </text>
                                    <text
                                        textAnchor="middle"
                                        y={5}
                                        style={{
                                            fill: '#ffffff',
                                            fontSize: '20px',
                                            fontWeight: 'bold',
                                            pointerEvents: 'none'
                                        }}
                                    >
                                        {(region.value / 1000).toFixed(1)}k
                                    </text>
                                </g>
                            </Marker>
                        );
                    })}
                </ComposableMap>
                
                {/* 호버 시 툴팁 */}
                {tooltipContent && (
                    <Tooltip>
                        {tooltipContent}
                    </Tooltip>
                )}
            </MapWrapper>
        </MapContainer>
    );
};

export default RegionStatsMap;
